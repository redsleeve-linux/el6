diff -up ImageMagick-6.7.2-7/config/delegates.xml.in.cve-2016-3717 ImageMagick-6.7.2-7/config/delegates.xml.in
--- ImageMagick-6.7.2-7/config/delegates.xml.in.cve-2016-3717	2011-09-15 02:58:06.000000000 +0200
+++ ImageMagick-6.7.2-7/config/delegates.xml.in	2016-05-05 15:20:19.998803702 +0200
@@ -76,11 +76,11 @@
   <delegate decode="hpgl" command="if [ -e @HPGLDecodeDelegate@ -o -e /usr/bin/@HPGLDecodeDelegate@ ]; then     @HPGLDecodeDelegate@ -q -m eps -f `basename &quot;%o&quot;` &quot;%i&quot;;     mv -f `basename &quot;%o&quot;` &quot;%o&quot;;   else     echo &quot;You need to install hp2xx to use HPGL files with ImageMagick.&quot;;     exit 1;   fi"/>
   <delegate decode="htm" command="&quot;@HTMLDecodeDelegate@&quot; -U -o &quot;%o&quot; &quot;%i&quot;"/>
   <delegate decode="html" command="&quot;@HTMLDecodeDelegate@&quot; -U -o &quot;%o&quot; &quot;%i&quot;"/>
-  <delegate decode="https" command="&quot;@WWWDecodeDelegate@&quot; -s -k -o &quot;%o&quot; &quot;https:%M&quot;"/>
+  <delegate decode="https" command="&quot;@WWWDecodeDelegate@&quot; -s -k -o &quot;%o&quot; &quot;https:%F&quot;"/>
   <delegate decode="ilbm" command="&quot;@ILBMDecodeDelegate@&quot; &quot;%i&quot; &gt; &quot;%o&quot;"/>
   <delegate decode="man" command="&quot;@MANDelegate@&quot; -man -Tps &quot;%i&quot; &gt; &quot;%o&quot;"/>
   <delegate decode="mpeg:decode" command="&quot;@MPEGDecodeDelegate@&quot; -v -1 -vframes %S -i &quot;%i&quot; -vcodec pam -an -f rawvideo -y &quot;%u.pam&quot; 2&gt; &quot;%Z&quot;"/>
-  <delegate encode="mpeg:encode" stealth="True" command="&quot;@MPEGEncodeDelegate@&quot; -v -1 -mbd rd -trellis 2 -cmp 2 -subcmp 2 -g 300 -i &quot;%M%%d.jpg&quot; &quot;%u.%m&quot; 2&gt; &quot;%Z&quot;"/>
+  <delegate encode="mpeg:encode" stealth="True" command="&quot;@MPEGEncodeDelegate@&quot; -v -1 -mbd rd -trellis 2 -cmp 2 -subcmp 2 -g 300 -i &quot;%F%%d.jpg&quot; &quot;%u.%m&quot; 2&gt; &quot;%Z&quot;"/>
   <delegate decode="sid" command="&quot;@MrSIDDecodeDelegate@&quot; -if sid -i &quot;%i&quot; -of tif -o &quot;%o&quot; &gt; &quot;%u&quot;"/>
   <delegate decode="pcl:color" stealth="True" command="&quot;@PCLDelegate@&quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &quot;-sDEVICE=@PCLColorDevice@&quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &quot;-r%s&quot; %s &quot;-sOutputFile=%s&quot; &quot;%s&quot;"/>
   <delegate decode="pcl:cmyk" stealth="True" command="&quot;@PCLDelegate@&quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &quot;-sDEVICE=@PCLCMYKDevice@&quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &quot;-r%s&quot; %s &quot;-sOutputFile=%s&quot; &quot;%s&quot;"/>
@@ -100,11 +100,11 @@
   <delegate decode="rgba" encode="rle" mode="encode" command="&quot;@RLEEncodeDelegate@&quot; -o &quot;%o&quot; -v &quot;%i&quot;"/>
   <delegate decode="scan" command="&quot;@SCANDecodeDelegate@&quot; -d &quot;%i&quot; &gt; &quot;%o&quot;"/>
   <delegate decode="scanx" command="&quot;@SCANDecodeDelegate@&quot; &gt; &quot;%o&quot;"/>
-  <delegate decode="miff" encode="show" spawn="True" command="&quot;@DisplayDelegate@&quot; -delay 0 -window-group %[group] -title &quot;%l &quot; &quot;ephemeral:%i&quot;"/>
+  <delegate decode="miff" encode="show" spawn="True" command="&quot;@DisplayDelegate@&quot; -delay 0 -window-group %[group] &quot;ephemeral:%i&quot;"/>
   <delegate decode="shtml" command="&quot;@HTMLDecodeDelegate@&quot; -U -o &quot;%o&quot; &quot;%i&quot;"/>
   <delegate decode="svg" command="&quot;@RSVGDecodeDelegate@&quot; &quot;%i&quot; &quot;%o&quot;"/>
   <delegate decode="txt" encode="ps" mode="bi" command="&quot;@TXTDelegate@&quot; -o &quot;%o&quot; &quot;%i&quot;"/>
-  <delegate decode="miff" encode="win" stealth="True" spawn="True" command="&quot;@DisplayDelegate@&quot; -immutable -delay 0 -window-group %[group] -title &quot;%l &quot; &quot;ephemeral:%i&quot;"/>
+  <delegate decode="miff" encode="win" stealth="True" spawn="True" command="&quot;@DisplayDelegate@&quot; -immutable -delay 0 -window-group %[group] &quot;ephemeral:%i&quot;"/>
   <delegate decode="wmf" command="&quot;@WMFDecodeDelegate@&quot; -o &quot;%o&quot; &quot;%i&quot;"/>
   <delegate decode="xps:color" stealth="True" command="&quot;@XPSDelegate@&quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &quot;-sDEVICE=@XPSColorDevice@&quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &quot;-r%s&quot; %s &quot;-sOutputFile=%s&quot; &quot;%s&quot;"/>
   <delegate decode="xps:cmyk" stealth="True" command="&quot;@XPSDelegate@&quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &quot;-sDEVICE=@XPSCMYKDevice@&quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &quot;-r%s&quot; %s &quot;-sOutputFile=%s&quot; &quot;%s&quot;"/>
diff -up ImageMagick-6.7.2-7/config/policy.xml.cve-2016-3717 ImageMagick-6.7.2-7/config/policy.xml
--- ImageMagick-6.7.2-7/config/policy.xml.cve-2016-3717	2011-05-16 02:14:21.000000000 +0200
+++ ImageMagick-6.7.2-7/config/policy.xml	2016-05-05 15:19:46.533819886 +0200
@@ -35,6 +35,10 @@
   
     <policy domain="path" rights="read" pattern="/repository/*" />
 
+  Let's prevent possible exploits by removing the right to use indirect reads.
+ 
+    <policy domain="path" rights="none" pattern="@*" />
+ 
   Any large image is cached to disk rather than memory:
 
     <policy domain="resource" name="area" value="1gb"/>
@@ -54,4 +58,14 @@
   <!-- <policy domain="resource" name="thread" value="4"/> -->
   <!-- <policy domain="resource" name="throttle" value="0"/> -->
   <!-- <policy domain="resource" name="time" value="3600"/> -->
+  <policy domain="coder" rights="none" pattern="EPHEMERAL" />
+  <policy domain="coder" rights="none" pattern="HTTPS" />
+  <policy domain="coder" rights="none" pattern="HTTP" />
+  <policy domain="coder" rights="none" pattern="URL" />
+  <policy domain="coder" rights="none" pattern="FTP" />
+  <policy domain="coder" rights="none" pattern="MVG" />
+  <policy domain="coder" rights="none" pattern="MSL" />
+  <policy domain="coder" rights="none" pattern="TEXT" />
+  <policy domain="coder" rights="none" pattern="LABEL" />
+  <policy domain="path" rights="none" pattern="@*" />
 </policymap>
diff -up ImageMagick-6.7.2-7/magick/property.c.cve-2016-3717 ImageMagick-6.7.2-7/magick/property.c
--- ImageMagick-6.7.2-7/magick/property.c.cve-2016-3717	2016-05-05 15:16:40.287909960 +0200
+++ ImageMagick-6.7.2-7/magick/property.c	2016-05-05 15:16:40.300909953 +0200
@@ -64,6 +64,7 @@
 #include "magick/monitor.h"
 #include "magick/montage.h"
 #include "magick/option.h"
+#include "magick/policy.h"
 #include "magick/profile.h"
 #include "magick/property.h"
 #include "magick/quantum.h"
@@ -2591,9 +2592,23 @@ MagickExport char *InterpretImagePropert
   if ((embed_text == (const char *) NULL) || (*embed_text == '\0'))
     return((char *) NULL);
   text=(char *) embed_text;
+  while ((isspace((int) ((unsigned char) *text)) != 0) && (*text != '\0'))
+    text++;
+  if (*text == '\0')
+    return(ConstantString(""));
   if ((*text == '@') && ((*(text+1) == '-') ||
       (IsPathAccessible(text+1) != MagickFalse)))
-    return(FileToString(embed_text+1,~0,&image->exception));
+  {
+      /* handle a '@' replace string from file */
+      if (IsRightsAuthorized(PathPolicyDomain,ReadPolicyRights,text) == MagickFalse)
+      {
+         errno=EPERM;
+         (void) ThrowMagickException(&image->exception,GetMagickModule(),
+           PolicyError,"NotAuthorized","`%s'",text);
+         return(ConstantString(""));
+       }
+    return(FileToString(text+1,~0,&image->exception));
+  }
   /*
     Translate any embedded format characters.
   */
@@ -2939,6 +2954,32 @@ MagickExport char *InterpretImagePropert
           MagickDisposeOptions,(ssize_t) image->dispose));
         break;
       }
+    case 'F':  
+    {
+      const char  
+        *q2;
+    
+      register char  
+        *p;  
+  
+      static char  
+        whitelist[] =  
+          "^-ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
+          "+&@#/%?=~_|!:,.;()";
+      /*  
+        Magick filename (sanitized) - filename given incl. coder & read mods.  
+      */
+      char val2[MaxTextExtent]; 
+      val2[0] = '\0';
+      (void) CopyMagickString(val2,image->magick_filename,MaxTextExtent);  
+      p=val2;  
+      q2=val2+strlen(val2);  
+      for (p+=strspn(p,whitelist); p != q2; p+=strspn(p,whitelist))  
+        *p='_'; 
+      q+=CopyMagickString(q,val2,strlen(val2));
+ 
+      break;
+    }
       case 'G':
       {
         q+=FormatLocaleString(q,extent,"%.20gx%.20g",(double)

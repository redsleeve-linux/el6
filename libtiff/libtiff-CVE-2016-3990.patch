From ebe39c7489ea864b2fad4284a59514edc52b050f Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Nikola=20Forr=C3=B3?= <nforro@redhat.com>
Date: Wed, 20 Jul 2016 12:31:34 +0200
Subject: [PATCH 3/5] Fix CVE-2016-3990

---
 libtiff/tif_pixarlog.c | 18 +++++++++++++++++-
 1 file changed, 17 insertions(+), 1 deletion(-)

diff --git a/libtiff/tif_pixarlog.c b/libtiff/tif_pixarlog.c
index a4c932c..9975472 100644
--- a/libtiff/tif_pixarlog.c
+++ b/libtiff/tif_pixarlog.c
@@ -459,6 +459,7 @@ typedef	struct {
 	int			state;
 	int			user_datafmt;
 	int			quality;
+	tsize_t			tbuf_size;
 #define PLSTATE_INIT 1
 
 	TIFFVSetMethod		vgetparent;	/* super-class method */
@@ -854,6 +855,7 @@ PixarLogSetupEncode(TIFF* tif)
 	    td->td_samplesperpixel : 1);
 	tbuf_size = multiply(multiply(multiply(sp->stride, td->td_imagewidth),
 				      td->td_rowsperstrip), sizeof(uint16));
+	sp->tbuf_size = tbuf_size;
 	if (tbuf_size == 0)
 		return (0);
 	sp->tbuf = (uint16 *) _TIFFmalloc(tbuf_size);
@@ -1089,8 +1091,17 @@ PixarLogEncode(TIFF* tif, tidata_t bp, tsize_t cc, tsample_t s)
 	}
 
 	llen = sp->stride * td->td_imagewidth;
-
+	if (llen > sp->tbuf_size)	
+	{
+		TIFFErrorExt(tif->tif_clientdata, module, "%s: Encoder error: Buffer limit reached.", tif->tif_name);
+		exit (0);
+	}
 	for (i = 0, up = sp->tbuf; i < n; i += llen, up += llen) {
+		if (up > sp->tbuf+sp->tbuf_size)
+		{
+			TIFFErrorExt(tif->tif_clientdata, module, "%s: Encoder error: Buffer limit reached.", tif->tif_name);
+			exit (0);
+		}
 		switch (sp->user_datafmt)  {
 		case PIXARLOGDATAFMT_FLOAT:
 			horizontalDifferenceF((float *)bp, llen, 
@@ -1117,6 +1128,11 @@ PixarLogEncode(TIFF* tif, tidata_t bp, tsize_t cc, tsample_t s)
  
 	sp->stream.next_in = (unsigned char *) sp->tbuf;
 	sp->stream.avail_in = n * sizeof(uint16);
+	if (sp->stream.avail_in > sp->tbuf_size)
+	{
+		TIFFErrorExt(tif->tif_clientdata, module, "%s: Encoder error: Error within the calculation on ZLib buffer size.", tif->tif_name);
+		return (0);
+	}
 
 	do {
 		if (deflate(&sp->stream, Z_NO_FLUSH) != Z_OK) {
-- 
2.7.4


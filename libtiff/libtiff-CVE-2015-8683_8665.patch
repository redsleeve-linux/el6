From 0b11e767a5168f1a4c08237d71044a8da59293db Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Nikola=20Forr=C3=B3?= <nforro@redhat.com>
Date: Wed, 20 Jul 2016 12:19:14 +0200
Subject: [PATCH] Fix CVE-2015-8683 and CVE-2015-8665

---
 libtiff/tif_getimage.c | 55 +++++++++++++++++++++++++++++---------------------
 1 file changed, 32 insertions(+), 23 deletions(-)

diff --git a/libtiff/tif_getimage.c b/libtiff/tif_getimage.c
index 0af0a1c..1af5cca 100644
--- a/libtiff/tif_getimage.c
+++ b/libtiff/tif_getimage.c
@@ -178,23 +178,25 @@ TIFFRGBAImageOK(TIFF* tif, char emsg[1024])
 				    "Planarconfiguration", td->td_planarconfig);
 				return (0);
 			}
-			if( td->td_samplesperpixel != 3 )
-            {
-                sprintf(emsg,
-                        "Sorry, can not handle image with %s=%d",
-                        "Samples/pixel", td->td_samplesperpixel);
-                return 0;
-            }
 			break;
-		case PHOTOMETRIC_CIELAB:
-            if( td->td_samplesperpixel != 3 || td->td_bitspersample != 8 )
-            {
-                sprintf(emsg,
-                        "Sorry, can not handle image with %s=%d and %s=%d",
+			if( td->td_samplesperpixel != 3  || colorchannels != 3 )
+             {
+                 sprintf(emsg,
+                        "Sorry, can not handle image with %s=%d, %s=%d",
                         "Samples/pixel", td->td_samplesperpixel,
-                        "Bits/sample", td->td_bitspersample);
-                return 0;
-            }
+                        "colorchannels", colorchannels);
+                 return 0;
+             }
+		case PHOTOMETRIC_CIELAB:
+            if( td->td_samplesperpixel != 3 || colorchannels != 3 || td->td_bitspersample != 8 )
+             {
+                 sprintf(emsg,
+                         "Sorry, can not handle image with %s=%d, %s=%d and %s=%d",
+                         "Samples/pixel", td->td_samplesperpixel,
+                         "colorchannels", colorchannels,
+                         "Bits/sample", td->td_bitspersample);
+                 return 0;
+             }
 			break;
 		default:
 			sprintf(emsg, "Sorry, can not handle image with %s=%d",
@@ -246,6 +248,9 @@ TIFFRGBAImageBegin(TIFFRGBAImage* img, TIFF* tif, int stop, char emsg[1024])
 	uint16 *red_orig, *green_orig, *blue_orig;
 	int n_color;
 
+	if( !TIFFRGBAImageOK(tif, emsg) )
+		return 0;
+
 	/* Initialize to normal values */
 	img->row_offset = 0;
 	img->col_offset = 0;
@@ -2352,25 +2357,29 @@ PickContigCase(TIFFRGBAImage* img)
 		case PHOTOMETRIC_RGB:
 			switch (img->bitspersample) {
 				case 8:
-					if (img->alpha == EXTRASAMPLE_ASSOCALPHA)
+					if (img->alpha == EXTRASAMPLE_ASSOCALPHA &&
+                        img->samplesperpixel >= 4)
 						img->put.contig = putRGBAAcontig8bittile;
-					else if (img->alpha == EXTRASAMPLE_UNASSALPHA)
+					else if (img->alpha == EXTRASAMPLE_UNASSALPHA &&
+                             img->samplesperpixel >=4 )
 					{
                                             img->put.contig = putRGBUAcontig8bittile;
 					}
-					else
+					else if ( img->samplesperpixel >= 3 )
                                             img->put.contig = putRGBcontig8bittile;
 					break;
 				case 16:
-					if (img->alpha == EXTRASAMPLE_ASSOCALPHA)
+					if (img->alpha == EXTRASAMPLE_ASSOCALPHA &&
+                        img->samplesperpixel >= 4 )
 					{
                                             img->put.contig = putRGBAAcontig16bittile;
 					}
-					else if (img->alpha == EXTRASAMPLE_UNASSALPHA)
+					else if (img->alpha == EXTRASAMPLE_UNASSALPHA &&
+                        img->samplesperpixel >= 4 )
 					{
                                             img->put.contig = putRGBUAcontig16bittile;
 					}
-					else
+					else if ( img->samplesperpixel >= 3 )
 					{
                                             img->put.contig = putRGBcontig16bittile;
 					}
@@ -2378,7 +2387,7 @@ PickContigCase(TIFFRGBAImage* img)
 			}
 			break;
 		case PHOTOMETRIC_SEPARATED:
-			if (buildMap(img)) {
+			if (img->samplesperpixel >=4 && buildMap(img)) {
 				if (img->bitspersample == 8) {
 					if (!img->Map)
 						img->put.contig = putRGBcontig8bitCMYKtile;
@@ -2471,7 +2480,7 @@ PickContigCase(TIFFRGBAImage* img)
 			}
 			break;
 		case PHOTOMETRIC_CIELAB:
-			if (buildMap(img)) {
+			if (img->samplesperpixel == 3 && buildMap(img)) {
 				if (img->bitspersample == 8)
 					img->put.contig = initCIELabConversion(img);
 				break;
-- 
2.7.4


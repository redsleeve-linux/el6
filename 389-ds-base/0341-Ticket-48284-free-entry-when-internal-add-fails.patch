From 182a7aea5925d21b6080e6c449399f9a16d6859e Mon Sep 17 00:00:00 2001
From: Mark Reynolds <mreynolds@redhat.com>
Date: Tue, 22 Sep 2015 13:41:06 -0400
Subject: [PATCH 341/342] Ticket 48284 - free entry when internal add fails

Bug Description:  The entry passed to an internal add operaton is expected
                  to be consumed, but it is not freed during an internal
                  add when setting slapi_add_internal_pb() returns an error.

Fix Description:  Free the entry in slapi_add_internal_pb() when the operation
                  is not allowed.

https://fedorahosted.org/389/ticket/48284

Reviewed by: nhosoi(Thanks!)

(cherry picked from commit 622be8bfbc942fe100b8880df72db26e99e1c954)
(cherry picked from commit 82b4347bf7f8b29bd5e3e7734daa4aaa465fa57c)
---
 ldap/servers/slapd/add.c | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/ldap/servers/slapd/add.c b/ldap/servers/slapd/add.c
index 37060df..0198b1c 100644
--- a/ldap/servers/slapd/add.c
+++ b/ldap/servers/slapd/add.c
@@ -348,6 +348,12 @@ int slapi_add_internal_pb (Slapi_PBlock *pb)
 
 	if (!allow_operation (pb))
 	{
+		/* free the entry as it's expected to be consumed */
+		Slapi_Entry *e;
+		slapi_pblock_get(pb, SLAPI_ADD_ENTRY, &e);
+		slapi_pblock_set(pb, SLAPI_ADD_ENTRY, NULL);
+		slapi_entry_free(e);
+
 		slapi_send_ldap_result( pb, LDAP_UNWILLING_TO_PERFORM, NULL,
 						 "This plugin is not configured to access operation target data", 0, NULL );
 		return 0;
@@ -707,8 +713,8 @@ static void op_shared_add (Slapi_PBlock *pb)
 				slapi_pblock_get(pb, SLAPI_ENTRY_POST_OP, &pse);
 				do_ps_service(pse, NULL, LDAP_CHANGETYPE_ADD, 0);
 				/* 
-				 * If be_add succeeded, then e is consumed except the resurect case.
-				 * If it is resurect, the corresponding tombstone entry is resurected
+				 * If be_add succeeded, then e is consumed except the resurrect case.
+				 * If it is resurrect, the corresponding tombstone entry is resurrected
 				 * and put into the cache.
 				 * Otherwise, we set e to NULL to prevent freeing it ourselves.
 				 */
-- 
1.9.3

